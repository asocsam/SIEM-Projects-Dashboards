[Crypto Mining on Fresh Instance]
action.email = 0
alert.severity = high
alert.track = 1
alert_type = scheduled
autorun = 0
cron_schedule = */15 * * * *
disabled = 0
is_scheduled = 1
realtime_schedule = 0
request.ui_dispatch_app = search
request.ui_dispatch_view = search
search = index=telemetry sourcetype="aws.cloudtrail" action="RunInstances" \ 
  | stats earliest(_time) AS first_seen latest(_time) AS last_seen values(user) AS users BY src_ip instancename instanceid \ 
  | lookup threatintel_by_ip ip AS src_ip OUTPUTNEW category AS threat_category \ 
  | eval duration_minutes = round((last_seen-first_seen)/60,2) \ 
  | where duration_minutes < 30 AND like(instancename, "%-miner%") OR threat_category="crypto" \ 
  | table _time instanceid instancename src_ip users duration_minutes threat_category

[RDP Brute Force Campaign]
action.email = 0
alert.severity = high
cron_schedule = */10 * * * *
disabled = 0
is_scheduled = 1
search = index=telemetry sourcetype="windows:security" EventCode=4625 \ 
  | bin _time span=10m \ 
  | stats count AS failures values(Account_Name) AS accounts values(Source_Network_Address) AS src_ips BY _time host \ 
  | where failures > 15 \ 
  | join host [ search index=telemetry sourcetype="windows:security" EventCode=4624 earliest=-10m latest=now() | stats values(Account_Name) AS successful_account BY host ] \ 
  | eval brute_force = if(isnull(successful_account), "No Success", "Potential Compromise") \ 
  | table _time host failures accounts src_ips brute_force

[SMB Lateral Movement Anomaly]
action.email = 0
alert.severity = medium
cron_schedule = */5 * * * *
is_scheduled = 1
search = index=telemetry sourcetype="sysmon" EventCode=3 DestinationPort=445 \ 
  | stats values(Image) AS process values(User) AS users count BY Computer DestinationIp \ 
  | lookup local=true baseline_smb_access.csv Computer AS Computer DestinationIp AS DestinationIp OUTPUTNEW baseline_count \ 
  | eval delta = count - coalesce(baseline_count,0) \ 
  | where delta > 10 \ 
  | table _time Computer DestinationIp users process delta

[Encoded PowerShell Download Cradle]
action.email = 0
alert.severity = high
cron_schedule = */5 * * * *
is_scheduled = 1
search = index=telemetry sourcetype="powershell:operational" CommandLine="*encodedCommand*" \ 
  | rex field=CommandLine "(?<encoded>[A-Za-z0-9+/=]{30,})" \ 
  | eval decoded=base64decode(encoded) \ 
  | search decoded="IEX" OR decoded="Invoke-WebRequest" \ 
  | table _time ComputerName UserId CommandLine decoded

[High Entropy DNS Queries]
action.email = 0
alert.severity = medium
cron_schedule = */15 * * * *
is_scheduled = 1
search = index=telemetry sourcetype="network:dns" \ 
  | eval entropy=mvindex(mvappend(len(query),len(replace(query,"[A-Za-z]",""))),0) \ 
  | stats avg(entropy) AS avg_entropy count BY src_ip query_type \ 
  | where avg_entropy > 35 AND count > 50 \ 
  | table _time src_ip query_type avg_entropy count
